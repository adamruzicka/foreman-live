#!/bin/bash

set -x
set -e

[[ -z "$1" ]] && echo "Usage: $0 flive-name.ks [RELEASE_NUMBER]" && exit 1

VERSION=$(git describe --abbrev=0 --tags || true)
RELEASE=$(date +%Y%m%d).${2:-1}
KS_INSTALL=flive-install.ks
KS_TARGET=flive-image.ks
OVERLAY="/usr/bin/livecd-debug
  /usr/share/foreman-live/VERSION
  /usr/share/foreman-live/RELEASE
  /etc/systemd/system/nm-prepare.service
  /usr/bin/nm-prepare
  /usr/bin/find-missing-libs
  /usr/bin/find-largest-rpms"

# prepare version and release files
echo "$VERSION" > root/usr/share/foreman-live/VERSION
echo "$RELEASE" > root/usr/share/foreman-live/RELEASE

# generate install overlay
echo "# <generated by build-livecd>" > $KS_INSTALL
for FILE in $OVERLAY; do
cat >> $KS_INSTALL <<EOF
%post
mkdir -p \$(dirname $FILE)
cat > $FILE <<'CODE'
$(cat root$FILE)
CODE
[ -x /sbin/restorecon ] && /sbin/restorecon $FILE
%end
EOF
done
cat >> $KS_INSTALL <<KS
%post
chmod +x \
  /usr/bin/livecd-debug \
  /usr/bin/find-missing-libs \
  /usr/bin/find-largest-rpms \
  /etc/rc.d/init.d/livesys \
  /etc/rc.d/init.d/livesys-late
/sbin/chkconfig --add livesys
/sbin/chkconfig --add livesys-late
%end
KS
echo "# </generated by build-livecd>" >> $KS_INSTALL

# prepare result kickstart
rm -f $KS_TARGET
ksflatten -c "$1" -o $KS_TARGET
echo "Now run as root ./build-livecd-root or submit $KS_TARGET into koji"
